name: "Create Tagged Release"

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version number of the release'
        required: true
      prerelease:
        description: 'Mark as pre-release (RC versions)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write
        
jobs:
  gh_tagged_release:
    name: Create tagged release
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout project
        uses: actions/checkout@v6

      - name: Setup Git
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061
        name: Install pnpm
        with:
          version: 9
          run_install: false
      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
            node-version: 20
            cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install

      - name: Set app version (Unix)
        run: npm version ${{ github.event.inputs.release_version }} --no-git-tag-version

      - name: Build Project
        run: pnpm run build

      - uses: actions/configure-pages@v5
      - uses: actions/setup-python@v6
        with:
          python-version: 3.x
      - run: pip install zensical
        working-directory: docs
      - run: zensical build --clean
        working-directory: docs
      - uses: actions/upload-pages-artifact@v4
        with:
          path: docs/site
      - uses: actions/deploy-pages@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b #v2
        id: github_release
        with:
          name: "Release v$VERSION"
          tag_name: "$TAG_NAME"
          target_commitish: main
          draft: false
          prerelease: "$PRE_RELEASE"
          files: |
            release-artifacts/*.zip
            release-artifacts/checksums.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.release_version }}
          TAG_NAME: ${{ github.event.inputs.release_version }}
          PRE_RELEASE: ${{ github.event.inputs.prerelease }}

      - name: "Notify issues of release their fix is contained in"
        if: ${{ !github.event.inputs.prerelease }}
        uses: apexskier/github-release-commenter@3bd413ad5e1d603bfe2282f9f06f2bdcec079327 # v1.3.6
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          comment-template: |
            Release {release_link} addresses this.
